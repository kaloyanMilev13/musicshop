<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - MusicShop</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

 
</head>
<body class="admin-page">

<header class="site-header">
    <div class="nav-inner">
        <a href="index.html" class="brand">
            <div class="brand-icon">
                <span>‚ô´</span>
            </div>
            <div class="brand-text">
                <h1>MusicShop</h1>
                <p>Instruments ¬∑ Vinyls ¬∑ Merch</p>
            </div>
        </a>

        <nav class="nav-links">
            <a href="products.html">Products</a>
            <a href="favorites.html">Favorites</a>
            <a href="cart.html">Cart</a>
            <a href="orders.html">Orders</a>
            <a href="news.html">News</a>
            <a href="admin.html" class="active admin-only" id="adminLink">Admin</a>
        </nav>

        <div class="nav-secondary">
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <span id="themeIcon">üåû</span>
            </button>

            <button class="login-btn-header" id="loginBtn" onclick="window.location='login.html'" style="display:none">Log In</button>

            <div class="user-status-pill">
                <div class="user-status-dot"></div>
                <div id="userStatus">Not logged in.</div>
            </div>

            <button class="logout-btn" id="logoutBtn" style="display:none" onclick="logout()">
                <span>‚èè</span>
                Logout
            </button>
        </div>
    </div>
</header>

<main>
    <div class="page-wrapper">
        <!-- LEFT COLUMN: PRODUCTS -->
        <section class="admin-column">
            <div class="admin-card">
                <div class="admin-card-header">
                    <div>
                        <h2>Product management</h2>
                        <span>Add new products or edit existing ones</span>
                    </div>
                </div>

                <!-- PRODUCT FORM -->
                <div class="product-form-grid">
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input id="name" placeholder="Product name">
                    </div>

                    <div class="form-group">
                        <label for="artist">Artist (optional)</label>
                        <input id="artist" placeholder="Artist / Band">
                    </div>

                    <div class="form-group">
                        <label for="category">Main category</label>
                        <select id="category">
                            <option value="">Select main category</option>
                            <option value="Instruments">Instruments</option>
                            <option value="Music">Music</option>
                            <option value="Merch">Merch</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="subcategory">Subcategory</label>
                        <select id="subcategory">
                            <option value="">Select subcategory</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="price">Price (‚Ç¨)</label>
                        <input id="price" type="number" step="0.01" placeholder="e.g. 19.99">
                    </div>

                    <div class="form-group">
                        <label for="stock">Stock</label>
                        <input id="stock" type="number" placeholder="Available quantity">
                    </div>

                    <div class="form-group">
                        <label for="image_url">Image URL</label>
                        <input id="image_url" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" placeholder="Short description..."></textarea>
                    </div>
                </div>

                <!-- EXTRA FIELDS -->
                <div class="product-extra-groups">
                    <!-- For category = Music -->
                    <div id="musicFields" style="display:none;">
                        <div class="form-group">
                            <label for="format">Music format</label>
                            <input id="format" placeholder="Vinyl, CD, Digital, etc.">
                        </div>
                        <div class="form-group">
                            <label for="music_genre">Music genre</label>
                            <input id="music_genre" placeholder="Rock, Metal, Pop, etc.">
                        </div>
                    </div>

                    <!-- For Merch -> Clothing -->
                    <div id="merchClothingFields" style="display:none;">
                        <div class="form-group">
                            <label for="size">Size</label>
                            <input id="size" placeholder="S, M, L, XL, etc.">
                        </div>
                        <div class="form-group">
                            <label for="color">Color</label>
                            <input id="color" placeholder="Black, White, etc.">
                        </div>
                        <div class="form-group">
                            <label for="merch_type">Merch type</label>
                            <input id="merch_type" placeholder="T-Shirt, Hoodie, etc.">
                        </div>
                    </div>

                    <!-- For Instruments -->
                    <div id="instrumentFields" style="display:none;">
                        <div class="form-group">
                            <label for="instrument_subtype">Instrument subtype</label>
                            <input id="instrument_subtype" placeholder="Acoustic, Electric, etc.">
                        </div>
                    </div>

                    <!-- For Other -->
                    <div id="otherFields" style="display:none;">
                        <div class="form-group">
                            <label for="accessory_type">Accessory type</label>
                            <input id="accessory_type" placeholder="Cable, Stand, Case, etc.">
                        </div>
                    </div>
                </div>

                <div class="product-form-actions">
                    <button class="btn-outline" type="button" onclick="resetForm()">Reset</button>
                    <button class="btn-primary" type="button" onclick="addProduct()">Save product</button>
                </div>

                <!-- PRODUCT LIST -->
                <div class="product-list-container">
                    <div class="product-list-header">
                        <span>Existing products</span>
                        <span id="productCountLabel"></span>
                    </div>
                    <div id="productList">Loading...</div>
                </div>
            </div>
        </section>

        <!-- RIGHT COLUMN: ORDERS + NEWS -->
        <section class="admin-column">
            <!-- ORDERS -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <div>
                        <h2>All orders</h2>
                        <span>Admin view of every order</span>
                    </div>
                </div>
                <div id="admin_orders" class="orders-list">Loading orders...</div>
            </div>

            <!-- NEWS -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <div>
                        <h2>News management</h2>
                        <span>Post updates about events & drops</span>
                    </div>
                </div>

                <div class="news-form">
                    <div class="news-form-row">
                        <label for="news_title">Title</label>
                        <input type="text" id="news_title" placeholder="News title">
                    </div>
                    <div class="news-form-row">
                        <label for="news_content">Content</label>
                        <textarea id="news_content" placeholder="Full news content..."></textarea>
                    </div>
                    <div class="news-form-actions">
                        <button class="btn-outline" id="newsCancelBtn" type="button" style="display:none;" onclick="cancelNewsEdit()">Cancel</button>
                        <button class="btn-secondary" type="button" onclick="saveNews()" id="newsSaveBtn">Add news</button>
                    </div>
                </div>

                <div id="admin_news_list">Loading...</div>
            </div>
        </section>
    </div>
</main>

<footer>
    <div class="footer-inner">
        <span>¬© <span id="year"></span> MusicShop. All rights reserved.</span>
        <span>Built for your diploma project ¬∑ <a href="admin.html" id="adminFooterLink" class="admin-only">Admin panel</a></span>
    </div>
</footer>

<script>
    function logout() {
        fetch("/musicshop/api/logout.php", {
            credentials: "include"
        }).then(() => window.location = "index.html");
    }

    document.getElementById("year").textContent = new Date().getFullYear();

    // ===== THEME / ADMIN CHECK / LOGIN STATE =====
    document.addEventListener("DOMContentLoaded", function () {
        const themeToggle = document.getElementById("themeToggle");
        const themeIcon = document.getElementById("themeIcon");
        const logoutBtn = document.getElementById("logoutBtn");

        function applyTheme(theme) {
            if (theme === "dark") {
                document.body.classList.add("dark-theme");
                if (themeIcon) themeIcon.textContent = "üåô";
            } else {
                document.body.classList.remove("dark-theme");
                if (themeIcon) themeIcon.textContent = "üåû";
            }
        }
        const savedTheme = localStorage.getItem("theme");
        applyTheme(savedTheme === "dark" ? "dark" : "light");

        if (themeToggle) {
            themeToggle.addEventListener("click", () => {
                const isDark = document.body.classList.toggle("dark-theme");
                localStorage.setItem("theme", isDark ? "dark" : "light");
                if (themeIcon) themeIcon.textContent = isDark ? "üåô" : "üåû";
            });
        }

        // Hard admin gate: if admin_check.php is NOT ok, redirect away
        fetch("/musicshop/api/admin_check.php", { credentials: "include" })
            .then(r => {
                if (!r.ok) {
                    window.location = "index.html";
                    return;
                }
            })
            .catch(() => {
                window.location = "index.html";
            });

        // Login state (just for logout visibility)
        fetch("/musicshop/api/whoami.php", { credentials: "include" })
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                const loginBtn = document.getElementById("loginBtn");
                const loggedIn = data && data.logged_in;
                if (loggedIn) {
                    if (logoutBtn) logoutBtn.style.display = "inline-flex";
                    if (loginBtn) loginBtn.style.display = "none";
                } else {
                    if (logoutBtn) logoutBtn.style.display = "none";
                    if (loginBtn) loginBtn.style.display = "inline-flex";
                }
            })
            .catch(() => {
                if (logoutBtn) logoutBtn.style.display = "none";
                const loginBtn = document.getElementById("loginBtn");
                if (loginBtn) loginBtn.style.display = "inline-flex";
            });

        // After DOM ready, init admin logic
        initAdminPage();
    });

    // ===== PRODUCTS ADMIN LOGIC =====

    const CATEGORY_MAP = {
        "Instruments": ["Guitars", "Basses", "Drums", "Keys", "Studio", "DJ", "Amps", "Pedals", "Microphones", "Accessories", "Other"],
        "Music": ["Vinyls", "CDs", "Digital", "Cassette", "Boxset", "Other"],
        "Merch": ["Clothing", "Headwear", "Drinkware", "Posters", "Stickers", "Other"],
        "Other": ["Cables", "Stands", "Cases", "Maintenance", "Gift", "Other"]
    };

    let editId = null;          // current product edit id (null = add mode)
    let editingNewsId = null;   // current news edit id (null = add mode)

    function populateSubcategories(mainCat, selectedSub = "") {
        const sub = document.getElementById("subcategory");
        if (!sub) return;
        sub.innerHTML = '<option value="">Select subcategory</option>';

        if (CATEGORY_MAP[mainCat]) {
            CATEGORY_MAP[mainCat].forEach(s => {
                const opt = document.createElement("option");
                opt.value = s;
                opt.textContent = s;
                if (s === selectedSub) opt.selected = true;
                sub.appendChild(opt);
            });
        }
    }

    function updateExtraFields() {
        const catEl = document.getElementById("category");
        const subEl = document.getElementById("subcategory");
        const cat = catEl ? catEl.value : "";
        const sub = subEl ? subEl.value : "";

        const musicFields = document.getElementById("musicFields");
        const merchClothingFields = document.getElementById("merchClothingFields");
        const instrumentFields = document.getElementById("instrumentFields");
        const otherFields = document.getElementById("otherFields");

        if (musicFields) musicFields.style.display = "none";
        if (merchClothingFields) merchClothingFields.style.display = "none";
        if (instrumentFields) instrumentFields.style.display = "none";
        if (otherFields) otherFields.style.display = "none";

        if (cat === "Music" && musicFields) {
            musicFields.style.display = "block";
        }

        if (cat === "Merch" && sub === "Clothing" && merchClothingFields) {
            merchClothingFields.style.display = "block";
        }

        if (cat === "Instruments" &&
            (sub === "Guitars" || sub === "Basses" || sub === "Drums" || sub === "Keys") &&
            instrumentFields) {
            instrumentFields.style.display = "block";
        }

        if (cat === "Other" && otherFields) {
            otherFields.style.display = "block";
        }
    }

    function loadProductsList() {
        fetch("/musicshop/api/products.php", {
            credentials: "include"
        })
        .then(r => r.json())
        .then(data => {
            const box = document.getElementById("productList");
            const countLabel = document.getElementById("productCountLabel");
            if (!box) return;

            box.innerHTML = "";

            if (!data.ok) {
                box.innerText = "Error: " + data.error;
                if (countLabel) countLabel.textContent = "";
                return;
            }

            if (!data.products || data.products.length === 0) {
                box.innerText = "No products yet.";
                if (countLabel) countLabel.textContent = "0 products";
                return;
            }

            if (countLabel) {
                countLabel.textContent = data.products.length + " product" + (data.products.length !== 1 ? "s" : "");
            }

            data.products.forEach(p => {
                const row = document.createElement("div");
                row.className = "productRow";

                const main = document.createElement("div");
                main.className = "productRow-main";
                main.innerHTML = `
                    <div class="productRow-name">${p.name}</div>
                    <div class="productRow-meta">
                        ‚Ç¨${p.price} ¬∑ ${(p.category || "-")} / ${(p.genre || "-")}
                    </div>
                `;

                const actions = document.createElement("div");
                actions.className = "productRow-actions";

                const editBtn = document.createElement("button");
                editBtn.className = "btn-outline";
                editBtn.type = "button";
                editBtn.textContent = "Edit";
                editBtn.addEventListener("click", () => editProduct(p.id));

                const delBtn = document.createElement("button");
                delBtn.className = "btn-outline";
                delBtn.type = "button";
                delBtn.textContent = "Delete";
                delBtn.addEventListener("click", () => deleteProduct(p.id));

                actions.appendChild(editBtn);
                actions.appendChild(delBtn);

                row.appendChild(main);
                row.appendChild(actions);
                box.appendChild(row);
            });
        });
    }

    function deleteProduct(id) {
        if (!confirm("Delete this product?")) return;

        fetch(`/musicshop/api/admin_delete_product.php?id=${id}`, {
            method: "GET",
            credentials: "include"
        })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                loadProductsList();
            } else {
                alert("Error: " + (data.error || "Delete failed"));
            }
        });
    }

    function editProduct(id) {
        fetch("/musicshop/api/get_product.php?id=" + id, {
            credentials: "include"
        })
        .then(r => r.json())
        .then(data => {
            if (!data.ok || !data.product) {
                alert(data.error || "Product not found");
                return;
            }

            const p = data.product;

            document.getElementById("name").value = p.name || "";
            document.getElementById("artist").value = p.artist || "";
            document.getElementById("category").value = p.category || "";

            populateSubcategories(p.category, p.genre);

            document.getElementById("price").value = p.price;
            document.getElementById("stock").value = p.stock;
            document.getElementById("description").value = p.description || "";
            document.getElementById("image_url").value = p.image_url || "";

            if (document.getElementById("format")) document.getElementById("format").value = p.format || "";
            if (document.getElementById("music_genre")) document.getElementById("music_genre").value = p.music_genre || "";
            if (document.getElementById("size")) document.getElementById("size").value = p.size || "";
            if (document.getElementById("color")) document.getElementById("color").value = p.color || "";
            if (document.getElementById("merch_type")) document.getElementById("merch_type").value = p.merch_type || "";
            if (document.getElementById("instrument_subtype")) document.getElementById("instrument_subtype").value = p.instrument_subtype || "";
            if (document.getElementById("accessory_type")) document.getElementById("accessory_type").value = p.accessory_type || "";

            updateExtraFields();
            editId = id;
        });
    }

    function addProduct() {
        const payload = {
            name: document.getElementById("name").value,
            artist: document.getElementById("artist").value,
            category: document.getElementById("category").value,
            genre: document.getElementById("subcategory").value,
            price: parseFloat(document.getElementById("price").value),
            stock: parseInt(document.getElementById("stock").value),
            description: document.getElementById("description").value,
            image_url: document.getElementById("image_url").value,
            format: document.getElementById("format")?.value || null,
            music_genre: document.getElementById("music_genre")?.value || null,
            size: document.getElementById("size")?.value || null,
            color: document.getElementById("color")?.value || null,
            merch_type: document.getElementById("merch_type")?.value || null,
            instrument_subtype: document.getElementById("instrument_subtype")?.value || null,
            accessory_type: document.getElementById("accessory_type")?.value || null
        };

        if (!payload.name || !payload.category) {
            alert("Name and main category are required.");
            return;
        }

        if (editId === null) {
            // ADD
            fetch("/musicshop/api/admin_add_product.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) {
                    alert("Error: " + (data.error || "Add failed"));
                    return;
                }
                resetForm();
                loadProductsList();
            });
        } else {
            // EDIT
            payload.id = editId;

            fetch("/musicshop/api/admin_edit_product.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) {
                    alert("Error: " + (data.error || "Update failed"));
                    return;
                }
                resetForm();
                loadProductsList();
            });
        }
    }

    function resetForm() {
        ["name","artist","category","price","stock","description","image_url"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });

        const sub = document.getElementById("subcategory");
        if (sub) sub.innerHTML = '<option value="">Select subcategory</option>';

        ["format","music_genre","size","color","merch_type","instrument_subtype","accessory_type"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });

        const extraIds = ["musicFields","merchClothingFields","instrumentFields","otherFields"];
        extraIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = "none";
        });

        editId = null;
    }

    // ===== ORDERS ADMIN =====
    async function loadAllOrders() {
        const el = document.getElementById('admin_orders');
        if (!el) return;
        el.textContent = 'Loading orders...';

        try {
            const resp = await fetch('/musicshop/api/get_all_orders.php', { credentials: 'include' });
            const text = await resp.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                el.innerHTML = 'Error loading orders: <pre>' +
                    text.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])) +
                    '</pre>';
                return;
            }

            if (!data.ok) {
                el.textContent = 'Error loading orders: ' + (data.error || 'Unknown error');
                return;
            }

            if (!data.orders || data.orders.length === 0) {
                el.textContent = 'No orders yet.';
                return;
            }

            el.innerHTML = '';
            data.orders.forEach(order => {
                const items = (order.items || []).map(it =>
                    `<li>${it.name} - x${it.quantity} @ ‚Ç¨${Number(it.unit_price).toFixed(2)}</li>`
                ).join('');

                const div = document.createElement('div');
                div.className = 'admin-order-card';
                div.innerHTML = `
                    <div class="admin-order-header">
                        <strong>Order #${order.id}</strong>
                        <span>${order.created_at}</span>
                    </div>
                    <div class="admin-order-meta">
                        <div><strong>User:</strong> ${order.username || ''} ${order.email ? '('+order.email+')' : ''}</div>
                        <div><strong>Customer:</strong> ${order.customer_name || '-'}${order.customer_email ? ' ('+order.customer_email+')' : ''}${order.customer_phone ? ', '+order.customer_phone : ''}</div>
                        <div><strong>Address:</strong> ${(order.shipping_address || '')}, ${(order.shipping_city || '')} ${(order.shipping_postcode || '')}, ${(order.shipping_country || '')}</div>
                        ${order.customer_note ? `<div><strong>Note:</strong> ${order.customer_note}</div>` : ''}
                        <div><strong>Total:</strong> ‚Ç¨${Number(order.total_price).toFixed(2)}</div>
                    </div>
                    ${items ? `<ul class="admin-order-items">${items}</ul>` : ''}
                `;
                el.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            el.textContent = 'Error loading orders.';
        }
    }

    // ===== NEWS ADMIN (rewritten: no inline onclick, proper JS events) =====
    function loadAdminNews() {
        fetch('/musicshop/api/get_news.php')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('admin_news_list');
                if (!container) return;
                container.innerHTML = '';

                if (!data.ok) {
                    container.textContent = 'Error loading news.';
                    return;
                }

                if (!data.news || data.news.length === 0) {
                    container.textContent = 'No news yet.';
                    return;
                }

                data.news.forEach(n => {
                    const div = document.createElement('div');
                    div.className = 'news-item';

                    const titleEl = document.createElement('h3');
                    titleEl.textContent = n.title;

                    const metaEl = document.createElement('p');
                    const small = document.createElement('small');
                    small.textContent = n.created_at;
                    metaEl.appendChild(small);

                    const contentEl = document.createElement('p');
                    contentEl.textContent = n.content;

                    const actions = document.createElement('div');
                    actions.className = 'news-item-actions';

                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'btn-outline';
                    editBtn.textContent = 'Edit';
                    editBtn.addEventListener('click', () => startNewsEdit(n));

                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.className = 'btn-outline';
                    delBtn.textContent = 'Delete';
                    delBtn.addEventListener('click', () => deleteNews(n.id));

                    actions.appendChild(editBtn);
                    actions.appendChild(delBtn);

                    div.appendChild(titleEl);
                    div.appendChild(metaEl);
                    div.appendChild(contentEl);
                    div.appendChild(actions);

                    container.appendChild(div);
                });
            })
            .catch(() => {
                const container = document.getElementById('admin_news_list');
                if (container) container.textContent = 'Error loading news.';
            });
    }

    function startNewsEdit(news) {
        editingNewsId = news.id;
        document.getElementById('news_title').value = news.title || '';
        document.getElementById('news_content').value = news.content || '';
        document.getElementById('newsSaveBtn').textContent = 'Save changes';
        document.getElementById('newsCancelBtn').style.display = 'inline-flex';
    }

    function cancelNewsEdit() {
        editingNewsId = null;
        document.getElementById('news_title').value = '';
        document.getElementById('news_content').value = '';
        document.getElementById('newsSaveBtn').textContent = 'Add news';
        document.getElementById('newsCancelBtn').style.display = 'none';
    }

    function saveNews() {
        const title = document.getElementById('news_title').value.trim();
        const content = document.getElementById('news_content').value.trim();

        if (!title || !content) {
            alert('Please fill title and content.');
            return;
        }

        // ADD
        if (editingNewsId === null) {
            fetch('/musicshop/api/admin_add_news.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ title, content })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) {
                    alert('Error adding news: ' + (data.error || 'Unknown error'));
                    return;
                }
                cancelNewsEdit();
                loadAdminNews();
            });
        } else {
            // EDIT
            fetch('/musicshop/api/admin_edit_news.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ id: editingNewsId, title, content })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) {
                    alert('Error updating news: ' + (data.error || 'Unknown error'));
                    return;
                }
                cancelNewsEdit();
                loadAdminNews();
            });
        }
    }

    function deleteNews(id) {
        if (!confirm("Delete this news item?")) return;

        const formData = new FormData();
        formData.append('id', id);

        fetch('/musicshop/api/admin_delete_news.php', {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (!data.ok) {
                alert('Error deleting news: ' + (data.error || 'Unknown error'));
                return;
            }
            if (editingNewsId === id) {
                cancelNewsEdit();
            }
            loadAdminNews();
        });
    }

    // ===== INIT =====
    function initAdminPage() {
        // Category change handlers
        const catEl = document.getElementById("category");
        const subEl = document.getElementById("subcategory");
        if (catEl) {
            catEl.addEventListener("change", () => {
                populateSubcategories(catEl.value);
                updateExtraFields();
            });
        }
        if (subEl) {
            subEl.addEventListener("change", updateExtraFields);
        }

        loadProductsList();
        loadAllOrders();
        loadAdminNews();
    }
</script>

<script src="js/script.js"></script>
</body>
</html>

